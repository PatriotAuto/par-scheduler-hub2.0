// prisma/schema.prisma
generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  ADMIN
  MANAGER
  DISPATCH
  TECH
  VIEW_ONLY
  USER
}

enum AppointmentStatus {
  SCHEDULED
  CONFIRMED
  IN_PROGRESS
  DONE
  CANCELED
  NO_SHOW
}

enum WorkStatus {
  TODO
  ASSIGNED
  IN_PROGRESS
  DONE
  CANCELED
}

enum WorkSource {
  MANUAL
  DEALER
  RINGCENTRAL
  ORBISX
}

enum DayOfWeek {
  MON
  TUE
  WED
  THU
  FRI
  SAT
  SUN
}

model Tenant {
  id        String   @id @default(cuid())
  name      String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users        User[]
  techs        Tech[]
  appointments Appointment[]

  serviceCategories ServiceCategory[]
  services          Service[]
  skills            Skill[]
  bays              Bay[]

  techScheduleRules TechScheduleRule[]
  techTimeOff       TechTimeOff[]
  holidays          Holiday[]

  workItems WorkItem[]
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  role      Role     @default(TECH)
  tenantId  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id])
}

model Tech {
  id        String   @id @default(cuid())
  name      String
  tenantId  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant       Tenant        @relation(fields: [tenantId], references: [id])
  appointments Appointment[]

  skills        TechSkill[]
  scheduleRules TechScheduleRule[]
  timeOff       TechTimeOff[]

  workItems WorkItem[] @relation("WorkItem_AssignedTech")
  workLogs  WorkLog[]
}

model ServiceCategory {
  id        String   @id @default(cuid())
  tenantId  String
  name      String
  sortOrder Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant   Tenant    @relation(fields: [tenantId], references: [id])
  services Service[]

  @@unique([tenantId, name])
}

model Service {
  id          String   @id @default(cuid())
  tenantId    String
  name        String
  categoryId  String?
  defaultMins Int      @default(60)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  tenant   Tenant           @relation(fields: [tenantId], references: [id])
  category ServiceCategory? @relation(fields: [categoryId], references: [id])

  requiredSkills ServiceRequiredSkill[]
  appointments   Appointment[]
  workItems      WorkItem[]

  @@unique([tenantId, name])
}

model Skill {
  id        String   @id @default(cuid())
  tenantId  String
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant     Tenant                 @relation(fields: [tenantId], references: [id])
  techs      TechSkill[]
  requiredBy ServiceRequiredSkill[]

  @@unique([tenantId, name])
}

model TechSkill {
  id        String   @id @default(cuid())
  tenantId  String
  techId    String
  skillId   String
  level     Int      @default(1)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tech  Tech  @relation(fields: [techId], references: [id])
  skill Skill @relation(fields: [skillId], references: [id])

  @@unique([techId, skillId])
  @@index([tenantId, techId])
}

model ServiceRequiredSkill {
  id        String @id @default(cuid())
  tenantId  String
  serviceId String
  skillId   String
  minLevel  Int    @default(1)

  service Service @relation(fields: [serviceId], references: [id])
  skill   Skill   @relation(fields: [skillId], references: [id])

  @@unique([serviceId, skillId])
}

model Bay {
  id        String   @id @default(cuid())
  tenantId  String
  name      String
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant       Tenant        @relation(fields: [tenantId], references: [id])
  appointments Appointment[]
  workItems    WorkItem[]

  @@unique([tenantId, name])
}

model TechScheduleRule {
  id        String    @id @default(cuid())
  tenantId  String
  techId    String
  day       DayOfWeek
  startTime String // "08:00"
  endTime   String // "17:00"
  isWorking Boolean   @default(true)

  tenant Tenant @relation(fields: [tenantId], references: [id])
  tech   Tech   @relation(fields: [techId], references: [id])

  @@unique([techId, day])
}

model TechTimeOff {
  id        String   @id @default(cuid())
  tenantId  String
  techId    String
  startAt   DateTime
  endAt     DateTime
  reason    String?
  createdAt DateTime @default(now())

  tenant Tenant @relation(fields: [tenantId], references: [id])
  tech   Tech   @relation(fields: [techId], references: [id])

  @@index([techId, startAt, endAt])
}

model Holiday {
  id        String   @id @default(cuid())
  tenantId  String
  name      String
  date      DateTime // store at midnight local; we’ll treat as “all day”
  createdAt DateTime @default(now())

  tenant Tenant @relation(fields: [tenantId], references: [id])

  @@unique([tenantId, date])
}

model Appointment {
  id          String  @id @default(cuid())
  title       String
  description String?

  startTime DateTime
  endTime   DateTime

  tenantId    String
  techId      String?
  bayId       String?
  serviceId   String?
  freeTextJob String? // for the “sometimes free text” requirement

  status   AppointmentStatus @default(SCHEDULED)
  source   WorkSource        @default(MANUAL)
  priority Int               @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant  Tenant   @relation(fields: [tenantId], references: [id])
  tech    Tech?    @relation(fields: [techId], references: [id])
  bay     Bay?     @relation(fields: [bayId], references: [id])
  service Service? @relation(fields: [serviceId], references: [id])

  @@index([tenantId, startTime, endTime])
  @@index([techId, startTime, endTime])
  @@index([bayId, startTime, endTime])
}

model WorkItem {
  id       String @id @default(cuid())
  tenantId String

  // what the job is
  title       String
  description String?
  serviceId   String?
  freeTextJob String?

  // scheduling / constraints
  promisedAt   DateTime?
  durationMins Int       @default(60)
  bayId        String?
  priority     Int       @default(0)

  // assignment / status
  status         WorkStatus @default(TODO)
  source         WorkSource @default(DEALER)
  assignedTechId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant  Tenant   @relation(fields: [tenantId], references: [id])
  service Service? @relation(fields: [serviceId], references: [id])
  bay     Bay?     @relation(fields: [bayId], references: [id])

  assignedTech Tech? @relation("WorkItem_AssignedTech", fields: [assignedTechId], references: [id])

  workLogs WorkLog[]

  @@index([tenantId, status, priority])
  @@index([assignedTechId, status])
}

model WorkLog {
  id         String @id @default(cuid())
  tenantId   String
  techId     String
  workItemId String

  startedAt DateTime  @default(now())
  endedAt   DateTime?

  tech     Tech     @relation(fields: [techId], references: [id])
  workItem WorkItem @relation(fields: [workItemId], references: [id])

  @@index([techId, startedAt])
}
